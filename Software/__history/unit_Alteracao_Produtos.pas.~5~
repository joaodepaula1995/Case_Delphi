unit unit_Alteracao_Produtos;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ExtCtrls, Vcl.Buttons,
  Vcl.WinXCalendars, Vcl.Mask, Vcl.DBCtrls;

type
  TFRM_ALTERACAO_PRODUTOS = class(TForm)
    pn_wallpaper: TPanel;
    lbl_alteracao: TLabel;
    btn_salvar: TBitBtn;
    lbl_informe: TLabel;
    txt_porcentagem: TEdit;
    procedure btn_salvarClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FRM_ALTERACAO_PRODUTOS: TFRM_ALTERACAO_PRODUTOS;
  Porcentagem: Double;

implementation

uses
  unit_Fecha_Sistema, unitDM_Categoria, unit_Mensagem, unit_Mensagem_Confirmacao, unit_Pesquisar, unit_Categoria, unitDM_Produto,
  unit_Produto;

{$R *.dfm}

procedure TFRM_ALTERACAO_PRODUTOS.btn_salvarClick(Sender: TObject);
  begin
  // Obter a porcentagem de aumento ou redução do usuário
  if TryStrToFloat(txt_porcentagem.Text, Porcentagem) then
  begin
    // Obter a data atual
    DataAlteracao := Now; // Suponha que DataAlteracao seja uma variável do tipo TDateTime

    // Converter a porcentagem em um fator multiplicador
    Porcentagem := 1 + (Porcentagem / 100);

    // Percorrer todos os registros
    DM_Produto.produto.First;
    while not DM_Produto.produto.Eof do
    begin
      // Salvar o valor anterior do campo preco no campo ultpreco
      DM_Produto.produto.Edit;
      DM_Produto.produto.FieldByName('ultpreco').Value := DM_Produto.produto.FieldByName('preco').Value;

      // Calcular e atualizar o novo valor de preco com base na porcentagem
      DM_Produto.produto.FieldByName('preco').Value := DM_Produto.produto.FieldByName('preco').AsFloat * Porcentagem;

      // Atualizar a data de alteração
      DM_Produto.produto.FieldByName('dataalteracao').AsDateTime := DataAlteracao;

      // Postar as alterações no dataset
      DM_Produto.produto.Post;

      // Avançar para o próximo registro
      DM_Produto.produto.Next;
    end;

    // Confirmar as alterações no banco de dados
    DM_Produto.produto.ApplyUpdates(-1);
  end
  else
  begin
    ShowMessage('Porcentagem inválida.');
  end;

//      try
//        FRM_MENSAGEM_CONFIRMACAO.lbl_mensagem.Caption := 'Deseja continuar com a alteração?';
//        FRM_MENSAGEM_CONFIRMACAO.ShowModal;
//      finally
//        if FRM_MENSAGEM_CONFIRMACAO.CONFIRMACAO = 'S' then
//        begin
//        FRM_MENSAGEM.lbl_mensagem.Caption := 'Alteração realizada com sucesso!';
//        FRM_MENSAGEM.ShowModal;
//        end;
//      end;
//    end;

end;
end.
